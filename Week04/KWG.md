# 네트워크 계층

## Introduction
네트워크 계층의 역할
1. 주소 정의
2. 종단 노드 호스트까지의 패킷 전송을 가능하게 하는 라우팅 역할
3. 패킷을 분할 및 재조립
--> 종단 노드간 통신이 가능하도록 하는 계층
<br><br>
네트워크 계층에서 잘 알려진 프로토콜
- IP: 비연결형 데이터 전달 서비스
- ARP, RARP: 주소 변환&역변환 프로토콜
- ICMP: 오류 전달 서비스 제공
- IGMP: 멀티캐스트 지원
<br><br><br>
## IP주소
1. 인터넷에 연결된 모든 장치들을 유일하게 구분할 수 있는 방법 제시 --> IP주소가 유일해야하는 이유.
2. 장치의 이름이 아닌 네트워크상에서의 위치를 나타내는 수단. 
<br><br>
### 클래스 기반 주소 지정
#### 클래스별 주소 비교
|클래스|주소 개수|차지 비율|주소 범위|
|:---:|:---:|:---|:---:|
|A|$2^{31}$|50%|0.0.0.0 ~ 127.255.255.255|
|B|$2^{30}$|25%|128.0.0.0 ~ 191.255.255.255|
|C|$2^{29}$|12.5%|192.0.0.0 ~ 223.255.255.255|
|D|$2^{28}$|6.25%|224.0.0.0 ~ 239.255.255.255|
|E|$2^{28}$|6.25%|240.0.0.0 ~ 255.255.255.255|

<br>  

#### 클래스별 주소 구조  
<img src=http://www.itmembers.net/lecture/is2-1.gif>  

- 클래스 A : 네트워크 내에 많은 수의 호스트나 라우터를 사용하는, 규모가 큰 기관을 위해 설계됨.  
  네트워크 식별자(NetID)가 7비트이기 때문에 126($2^7-2$)개의 네트워크가 있으며,  
  각 네트워크 당 16,777,216($2^{24}$)개의 주소를 가질 수 있지만, 실제로 대부분이 낭비된다.  

- 클래스 B : 16,384($2^{14}$)개의 서로 다른 NetID를 가지는 네트워크가 있으며, 각 네트워크 블록은 65,536($2^{16}$)개의 주소를 가질 수 있다.  
  하지만 중형 기관을 위해 설계된 클래스의 특성 상 대부분의 주소들이 낭비되고 있다. (할당은 되었지만 실제 사용되지 않는 여분의 주소가 많음)  

- 클래스 C : 2,097,152($2^{21}$)개의 서로 다른 NetID를 가지는 네트워크가 있으며, 각 네트워크 블록은 256($2^8$)개의 주소를 가질 수 있다.  
  하지만 소규모 기관을 설계된 이 클래스는 할당된 주소의 수가 소규모 기관들의 호스트 수보다 적어 사용하지 않기 때문에 낭비되어지고 있다.

- 클래스 D : 하나의 네트워크 블록으로 이루어져있으며, 각각의 주소는 인터넷 호스트들의 한 그룹을 정의하는데 사용된다.  
  하나의 그룹에 클래스 D에 속하는 주소가 할당되면, 이 그룹의 멤버들은 모든 호스트들이 갖고 있는 유니캐스트 주소에 추가적으로 멀티 캐스트 주소를 가진다.

- 클래스 E : 하나의 네트워크 블록으로 이루어져있으며, 미래 사용을 위해 예약되었으나 사실상 낭비되어지고있다.
<br><br>
#### IPv4 주소체계 및 클래스 기반 주소 구조의 문제점
1. 인터넷 사용자 수의 증가로 인한 IP 주소 고갈 (IPv4)
2. 클래스 별로 각 그룹에 할당된 IP 주소의 수가 실제 수요와는 매우 다름으로 인한 주소 낭비 (클래스 기반 주소)  

--> 서브넷, 슈퍼넷, Classless 방식으로 해결
<br><br>

### 마스크
네트워크 ID가 주어질 때 그 네트워크에 대한 호스트 주소의 범위를 알아내거나  
임의의 호스트 ID가 주어졌을 때 그 네트워크의 시작 주소를 알아낼 때 사용하다.  
--> 네트워크 주소를 알아낸 후 패킷 경로를 지정할 수 있기 때문에 네트워크 주소를 알아내는 과정은 매우 중요

#### 각 클래스별 디폴트 마스크

<img src=https://velog.velcdn.com/images/rlghks9806/post/bf9e41f6-f673-488a-aedd-a81178383227/image.png width=700>
<br><br>

### 특수 주소  
클래스 A,B,C에서 NetID 또는 HostID의 주소가 모두 0이거나 모두 1인 경우는 특수 주소로 취급되며,  
이 주소들은 일반 사용자들에게 할당되지 않는다.  

|특수 주소 설명|NetID|HostID|발신지/목적지|
|:---|:--:|:--:|:--:|
|네트워크 블록 대표 주소|특정 네트워크|모두 0| - |
|직접 브로드캐스트 주소|특정 네트워크|모두 1|목적지 주소|
|제한된 브로드캐스트 주소|모두 1|모두 1|목적지 주소|
|현재 네트워크에 있는 호스트|모두 0|모두 0|발신지 주소|
|현재 네트워크에 있는 특정 호스트|모두 0|특정 호스트|목적지 주소|
|루프백 주소|127|임의의 호스트|목적지 주소|
* 네트워크 블록 대표 주소 : 블록의 첫 번째 주소(시작 주소)를 나타낸다.
* 직접 브로드캐스트 주소 : HostID가 모두 1인 주소. 라우터가 특정 네트워크 내에 있는 모든 호스트에 패킷을 보낼 때 사용
* 제한된 브로드캐스트 주소 : 현재 네트워크 내의 다른 모든 호스트들에게 메시지를 전송할 때 사용. 동일 네트워크 내에서만 브로드캐스팅한다.  
  (라우터가 이 패킷을 수신할 경우 외부 네트워크로 전송되지 않도록 패킷을 막는다.)
* 현재 네트워크에 있는 호스트 : 자신의 IP 주소를 모르는 호스트가 자신의 IP주소를 알아내는 부트스트랩(Bootstrap) 시간에 사용
* 현재 네트워크에 있는 특정 호스트 : 동일한 네트워크에 있는 다른 호스트에게 메시지를 보낼 때 사용
* 루프백 주소 : 컴퓨터에 설치된 소프트웨어를 시험하기 위해 사용한다. (ex. 디버거)
<br><br><br>

## 클래스 체계의 주소 낭비를 막기 위한 방법
### 클래스 체계를 이용하는 방법
#### 서브넷팅(Subnetting)
클래스 A, B와 같이 각 네트워크 내의 호스트 수가 너무 많아 여분의 주소들이 사용되지 않아 낭비되는 것을 막기 위해  
하나의 큰 네트워크를 여러 개의 서브네트워크(서브넷, Subnet)로 나누는 작업  
<br>

#### 슈퍼넷팅 (Supernetting)
클래스 C와 같이 각 네트워크 내의 호스트 수가 너무 적어 상위 클래스의 네트워크 블록을 할당받음으로 인해  
C클래스가 사용되지 않아 낭비되는 것을 막기 위해
여러 개의 작은 네트워크를 하나의 큰 슈퍼네트워크(슈퍼넷, Supernet)로 합치는 작업  

<br>클래스 C에서의 서브네팅, 슈퍼네팅 예시<br>
<img src=https://velog.velcdn.com/images/rlghks9806/post/0a704fb2-15f7-4ee1-9314-6ff22836c484/image.png width=700> <br>

### 클래스가 없는 주소 지정
#### 프리픽스&서픽스
<img src=https://velog.velcdn.com/images/rlghks9806/post/11cc1708-6ea8-4018-930a-ff4e5cd2d771/image.png width=700>

- 프리픽스(Prefix): 클래스 주소 지정 방식에서의 NetID와 유사한 개념으로,  
일반적인 IPv4 주소 뒤에 "/(프리픽스의 길이)"를 붙이는 방법으로 네트워크 주소의 길이를 나타낸다.  
- 서픽스(Suffix)는 HostID와 유사한 개념으로, 서픽스의 길이는 $32-(프리픽스 길이)$ 이다.<br>  

<img src=https://velog.velcdn.com/images/rlghks9806/post/73e80be1-8b4a-4dfd-a0f2-3b4c32a9aa2b/image.png width=700> <br>
└ 프리픽스 주소체계의 구조
<br><br><br>

## 패킷의 전달과 라우팅
* 용어 정리
  * 포워딩(Forwarding): 패킷을 목적지로 가는 경로 상에 놓는 것
  * 라우팅(Routing) 포워딩을 돕기 위해 라우팅 테이블을 생성하여 패킷의 경로를 설정하는 것
<br><br>

### 패킷의 전달
네트워크 계층은 아래 층의 물리 네트워크에 의해 패킷이 처리되는 과정을 감독한다.  
이 때 연결 유형에 따라 연결형 서비스와 비연결형 서비스로 나눌 수 있고,  
또 전달 유형에 따라 직접 전달과 간접 전달의 두 가지 방식이 있다.
<br>
|연결형 서비스| 비연결형 서비스|
|:--:|:--:| 
|패킷을 보내기 전 먼저 네트워크 계층 프로토콜이 <br> 원격지 네트워크 계층 프로토콜과 연결을 설정함|각 패킷을 상호 독립적으로 취급하며<br> 패킷들 사이에는 아무 관계가 없음|
|연결이 설정되면 같은 발신지에서 같은 목적지로 발송되는 패킷이 순서대로 전달|하나의 메시지에 속하는 패킷들이 같은 목적지로 전달되더라도<br>서로 다른 경로로 전달됨|
|패킷들 사이에 서로 상관관계가 유지됨|-|
|모든 패킷이 같은 경로를 경유하여 전달됨|-| <br>

연결형 서비스의 경우 같은 발신지와 같은 목적지를 같는 패킷의 순서에 대한 경로를 설정하는 과정은  
연결이 설정될 때 한 번 수행된다.  
비연결형 서비스에서 패킷의 경로에 대한 결정은 각 라우터에 의해 상호 독립적으로 이루어진다.  
<br><br>
### 직접 전달과 간접 전달
패킷 전달 과정에서는 반드시 하나의 직접 전달과정이 있으나, 간접 전달은 없거나 여러 개가 있을 수 있다.  
또한, 마지막 패킷의 전달은 반드시 직접 전달이다.
<br><br>

|연결형 서비스| 비연결형 서비스|
|:--:|:--:| 
|패킷의 발신지와 목적지가<br>같은 네트워크에 위치할 때|목적지 호스트가 발신자와 같은 네트워크에 있지 않을 때|
|전달이 최종 라우터와 목적지 호스트 사이에 수행|최종 목적지의 물리적 네트워크에 연결된 라우터에 도달할 때까지<br>여러 라우터를 경유|
|마스크 사용시, 마스킹 후 목적지 네트워크 주소와<br>자신이 연결된 네트워크 주소가 같을 때 직접 전달|목적지 IP주소와 라우팅 테이블을 이용해<br>패킷이 전달되어야 하는 다음 라우터의 IP주소 찾음|
|송신자는 목적지 IP 주소를 사용해 목적지의 물리 주소를 알아냄<br>(ARP 프로토콜 이용)|송신자는 ARP 프로토콜을 이용해 다음 라우터의 물리주소를 찾음|
|주소 변환은 최종 목적지의 IP 주소와<br>최종 목적지의 물리주소 사이에 변환됨| 주소 변환은 다음 라우터의 IP 주소와 <br>다음 라우터의 물리 주소 사이에서 변환됨
<br><br>
### 포워딩 기술
패킷을 목적지로 가는 경로 상에 놓아야 하는 포워딩 기술 특성 상 호스트나 라우터는 라우팅 테이블을 가지고 있어야 하는데,  
현재의 인터넷과 같이 많은 호스트가 있는 경우 이러한 라우팅 테이블의 크기가 매우 크기 때문에 라우팅에 대한 질의가 비효율적이다.  
이를 해결하기 위해 몇 가지 지술을 이용해 라우팅 테이블의 크기를 충분히 작게 만들면서도 보안 문제를 다룰 수 있다.  

1. 다음 홉 방법 : 라우팅 테이블이 전체 경로에 대한 정보 대신 다음홉의 주소만 저장함으로써 크기의 일관성을 유지함.  
2. 네트워크 지정 방법 : 같은 네트워크에 연결된 모든 호스트를 하나의 객체로 취급하여 라우팅 테이블에는 하나의 객체만 저장시키는 방식.
3. 호스트 지정 방법 : 라우팅 테이블의 크기 효율성을 포기한 대신 관리자가 라우팅 테이블을 직접 제어할 수 있도록 사용성을 늘린 방식. 
4. 디폴트 방법 : 다른 네트워크들과 구분되어야 하는 특정 네트워크의 주소만 가지고 나머지는 전부 0.0.0.0의 디폴트 주소로 라우팅 시키는 방식.
<br><br>

### 라우팅
라우팅 테이블을 생성하고 유지하는 일련의 과정이다.  
호스트와 라우터는 IP 패킷을 전달하기 위해 각 목적지 별로 하나의 엔트리를 가지고 있는 라우팅 테이블을 유지하고 있다.
- 정적 라우팅 테이블: 수동으로 입력된 정보를 저장하고 있기 때문에 네트워크 관리자가 테이블을 직접 지정,변경한다.  
  테이블이 자주 변경되지 않는 작은 인터넷이나 문제 해결을 위한 실헙적인 네트워크에서만 사용 가능하다. (현재의 일반적인 네트워크에서는 사용 불가)
- 동적 라우팅 테이블: RIP, OSPF, BGP와 같은 동적 라우팅 프로토콜을 사용해 주기적으로 라우팅 테이블을 변경/지정하는 방식.  
  라우터, 링크 등이 정지하는 등의 변화 발생시마다 동적 라우팅 프로토콜에서 라우터 내의 모든 테이블을 갱신한다.
<br><br>
#### 라우팅 테이블의 공통 필드
<img src=https://t1.daumcdn.net/cfile/tistory/2563F74A570F7EF51B width=700><br/>
- 마스크 : 엔트리에 적용될 마스크 정의
- 네트워크 주소 : 현재 패킷이 최종적으로 전달되어야 하는 네트워크 주소를 정의한다.
- 다음 홉 주소: 패킷이 전달되어야 하는 다음 홉 라우터의 주소를 정의
- 플래그: U, G, H, D, M의 5가지 플래그를 On/OFF 시킴으로서 유효 여부를 표시한다.
  |플래그|내용|
  |:--:|:--|
  |U<br>(up)|라우터가 동작하고 있는지 표시.<br> 이 플래그가 없다면 라우터가 동작중이 아니므로 패킷이 폐기된다.|
  |G<br>(gateway)|목적지가 다른 네트워크에 있는지 여부. 이 플래그가 있다면 다음 홉 라우터에 전달되어야 하므로 간접전달되고,<br>없다면 동일 네트워크 상에 있는 것이므로 직접전달 된다.|
  |H<br>(host-specific)|목적지 필드 내의 엔트리가 호스트 지정 주소라는 것을 나타냄. <br> 이 플래그가 없다면 주소는 목적지의 네트워크 주소임을 나타낸다.|
  |D<br>(added by redirection)|목적지에 대한 라우팅 정보가 ICMP에 의해 수신된 방향 재지정 메시지에 영향을 받아 추가되었다는 것을 의미한다.|
  |M<br>(modified by redirection)|목적지에 대한 라우팅 정보가 ICMP 프로토콜에 의해 수신된 방향 지정 메시지에 영향을 받아 수정되었음을 의미한다.|
- 참조 횟수 : 현재 시간에 이 경로를 사용하고 있는 사용자의 수
- 사용 : 라우터로부터 해당하는 목적지로 전달된 패킷의 수
- 인터페이스: 인터페이스의 이름
<br><br><br><br>

# IP
인터넷 프로토콜(IP)은 TCP/IP의 일부면서 OSI 7계층 중 3번째 계층인 네트워크 계층에 속한다.  
IP는 패킷 교환 네트워크를 위해 설계되었으며, 신뢰성이 없고 비연결형인 데이터그램 프로토콜이다.  
<br>
IP헤더에는 오류 제어나 흐름 제어의 기능을 위한 부분이 없으므로  
반드시 그 패킷이 목적지까지 전달된다는 보장이 없는 최선의 노력 전달 서비스를 제공한다.  
<br><br>

## 단편화와 MTU
데이터그램들이 서로 다른 네트워크를 지나갈 때, 각 라우터는 수신한 프레임에서 IP 데이터그램을 역캡슐화 한 후  
다른 프레임 속에 다시 캡슐화 한다.  
<br>
이 때 대부분의 프로토콜에서 각 데이터 링크 계층은 자신의 프레임 형식을 가지고 있으며,  
프레임의 형식에 정의된 필드 중의 하나는 데이터 필드의 최대 크기인 최대 전달 단위(Maximum Transfer Unit; MTU)이다.  
MTU의 값은 네트워크 프로토콜마다 다르지만, 가장 대표적인 프로토콜의 Ethernet의 MTU 값은 1500이다.
<br><br>

## 검사합(Checksum)
대부분의 TCP/IP 프로토콜에서의 오류검출방법은 검사합(check-sum)이다.  
<br>
송신자 측에서는 다음과 같이 검사합을 계산한다.  
1. 패킷을 크기가 n비트인 k개 조각으로 나눈다.
2. 모든 조각을 1의 보수 연산을 사용하여 합한다.
3. 합한 값에 대한 1의 보수가 검사합이다.
<br>

수신자 측에서는 다음과 같은 과정을 거친다.
1. 수신된 패킷을 k개의 조각으로 나눈 후 이들을 전부 합한다.
2. 구한 합에 대해 1의 보수를 취한다.
3. 만약 결과가 0일 경우 패킷이 오류가 없는 것이므로 받아들이고, 그렇지 않다면 거부한다.  
<br>
## IP 헤더 구조
<img src="https://mblogthumb-phinf.pstatic.net/20130616_238/printf7_13713818957646GBoN_PNG/IP_Header.png?type=w2"><br>
- 버전(VER) : IP 프로토콜의 버전을 나타낸다. 4 또는 6을 나타낸다.
- 헤더 길이(HLEN) : 데이터그램 헤더의 전체 길이를 4바이트 단위로 나타낸다. 예를 들어, 이 필드의 값이 5라면 전체 길이는 $5×4=20$ 이다.
- 차별화된 서비스(DS) : 우선순위, 신뢰도, 전송지연 시간, 성능 등의 파라미터를 통해 송신하고 있는 IP의 서비스 품질을 나타낸다.
- 전체 길이 : 헤더와 데이터를 포함하는 IP 데이터그램의 전체 길이를 바이트 단위로 나타낸다. 이 값에서 헤더 길이의 값을 빼면  
  순수 데이터의 길이를 알 수 있다.
- 데이터그램 식별자: 발신지 호스트로부터 나온 데이터그램을 유일하게 식별한다. 이 식별자는 목적지에서 데이터그램을 재조립하는데 사용된다.
- 플래그 : 3비트의 필드 중 첫번째 비트는 사용되지 않으며, 두 번째 비트는 단편화의 가능 여부(0: 가능, 1: 불가능),  
  세 번째 비트는 이후에 추가적인 단편화 비트가 있는지 여부를 알려준다. (0: 마지막 단편이거나 유일한 단편, 1: 추가적인 단편이 존재)  
- 단편화(패킷분할) 오프셋 : 전체 데이터그램 내에서 현재 데이터그램 패킷의 상대적인 위치를 나타낸다. 오프셋 값은 8바이트 단위로 나눠지므로 각 패킷의 첫 번째 바이트 번호는 8로 나누어떨어져야 한다.  
- 수명(존재시간 영역) : 데이터그램이 네트워크에 존재할 수 있는 생존 시간을 초 단위로 나타낸 것이다.  
- 프로토콜 : IP 계층의 서비스를 사용하는 상위 계층 프로토콜을 정의한다. 
  |프로토콜|프로토콜 필드 값|
  |:--:|:--:|
  |ICMP|1|
  |IGMP|2|
  |TMP|6|
  |EGP|8|
  |UDP|17|
  |OSPF|89|
- 검사합 : 헤더에 오류가 있는지 검출하는 코드이다. 이 값을 구하는 방법은 위쪽에 설명한 방식과 동일하다.
- 발신지 주소 : 이 데이터그램의 발신한 곳의 IP 주소를 담고있다.
- 목적지 주소 : 이 데이터그램의 최종 목적지 IP 주소를 담고있다.
- 옵션 : 네트워크를 시험하거나 디버깅하기 위해 사용되는 영역으로, 0~40 바이트까지 가변적인 길이를 갖는 영역이다.



<br><br><br><br>
# 문제

1. 주어진 IPv4 주소가 어느 클래스에 속하는지 말하고, 각 IP 주소의 대표주소(= 네트워크 시작주소)를 말하시오.  
   ① 172.30.1.254  
   ② 193.34.7.82  
   ③ 167.199.170.82/27  
<br>  

2. 다음 IP 헤더의 필드 중 틀린 설명을 모두 고르시오.  
   ① 헤더길이(HLEN) : 4비트 영역으로, 데이터그램 헤더의 전체 길이를 바이트 단위로 나타낸다.  
   ② 전체 길이 : 8비트 영역으로, 헤더와 데이터를 포함하는 IP 데이터그램의 전체 길이를 바이트 단위로 나타낸다.  
   ③ 플래그 : 3비트 영역으로, 첫 번째 비트는 긴급데이터 여부(E), 두 번째 비트는 단편화의 가능 여부(D),  
   세 번째 비트는 추가적인 데이터가 있는지 여부(M)를 나타낸다.  
   ④ 수명(존재시간) : 8비트 영역으로, 데이터그램이 네트워크에 존재할 수 있는 생존시간을 ms 단위로 나타낸 것이다.  
   ⑤ 버전(VER) : 4비트 영역으로, 전송된 데이터그램의 프로토콜 버전이 현재 시스템의 버전과 다른 경우  
   변환 과정을 거쳐 데이터를 읽을 수 있도록 하기 위한 영역이다.
